<div class="container fade-in">
  <div class="header-section">
    <div>
      <h2 class="title">Assign Users</h2>
      <p class="subtitle">Manage hotel access for managers and receptionists</p>
    </div>
  </div>

  <div class="assignment-card shadow-premium">
    <div class="assignment-form">
      <div class="form-group">
        <label>Select User</label>
        <div class="select-wrapper">
          <span class="iconify input-icon" data-icon="mdi:account-outline"></span>
          <select [(ngModel)]="selectedUserId" class="form-control">
            <option [ngValue]="null">Choose a manager or receptionist...</option>
            <option *ngFor="let u of assignableUsers" [ngValue]="u.userId">
              {{u.fullName}} ({{u.role}})
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Select Hotel</label>
        <div class="select-wrapper">
          <span class="iconify input-icon" data-icon="mdi:domain"></span>
          <select [(ngModel)]="selectedHotelId" class="form-control">
            <option [ngValue]="null">Choose a target hotel...</option>
            <option *ngFor="let h of hotels" [ngValue]="h.hotelId">
              {{h.hotelName}} - {{h.city}}
            </option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button (click)="assignUser()" [disabled]="!selectedUserId || !selectedHotelId || loading" class="btn-primary">
          <span class="iconify" data-icon="mdi:plus-circle-outline"></span>
          {{ loading ? 'Processing...' : 'Assign User' }}
        </button>
      </div>
    </div>
  </div>

  <div class="list-section">
    <div class="section-header">
      <div class="header-actions w-100 d-flex justify-content-between align-items-center">
        <!-- Big Search Applied Here -->
        <div class="search-box big-search" style="margin-bottom: 0; flex: 1; max-width: 400px;">
          <span class="iconify" data-icon="mdi:magnify"></span>
          <input type="text" placeholder="Search entries..." (keyup)="applyFilter($event)">
        </div>
        <button class="btn-refresh ms-auto" (click)="loadData()" [disabled]="loading" title="Sync Data">
          <span class="iconify" [class.spin]="loading" data-icon="mdi:sync"></span>
        </button>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMsg" class="alert alert-danger shadow-sm fade-in" role="alert">
      <span class="iconify me-2 fs-4" data-icon="mdi:alert-octagon"></span>
      <div>{{ errorMsg }}</div>
      <button class="btn-retry ms-auto" (click)="loadData()">Retry Sync</button>
    </div>

    <!-- Loading State -->
    <div class="loading-state py-5" *ngIf="loading && !errorMsg">
      <div class="spinner-premium"></div>
      <p class="mt-3 text-muted fw-500">Retrieving secure assignments...</p>
    </div>

    <!-- Assignments Table with MatTable -->
    <div class="table-container table-responsive fade-in" *ngIf="!loading">
      <table mat-table [dataSource]="dataSource" matSort class="table-premium w-100">

        <!-- User Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> User </th>
          <td mat-cell *matCellDef="let a">
            <div class="d-flex align-items-center gap-3">
              <div class="user-avatar-small">
                <span class="iconify" data-icon="mdi:account"></span>
              </div>
              <span class="fw-bold text-dark">{{ getUserEmail(a.userId) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Role Column -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Role </th>
          <td mat-cell *matCellDef="let a">
            <span class="role-badge">{{ getUserRole(a.userId) }}</span>
          </td>
        </ng-container>

        <!-- Hotel Column -->
        <ng-container matColumnDef="hotel">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Assigned Hotel </th>
          <td mat-cell *matCellDef="let a">
            <div class="d-flex align-items-center gap-2 text-muted">
              <span class="iconify" data-icon="mdi:map-marker"></span>
              {{ getHotelName(a.hotelId) }}
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center"> Status </th>
          <td mat-cell *matCellDef="let a" class="text-center">
            <span class="status-badge" [class.active]="a.isActive" [class.inactive]="!a.isActive">
              {{ a.isActive ? 'Active' : 'Suspended' }}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="text-end"> Actions </th>
          <td mat-cell *matCellDef="let a" class="text-end">
            <div class="action-buttons justify-content-end">
              <button class="btn-icon" (click)="toggle(a)" [title]="a.isActive ? 'Suspend Access' : 'Restore Access'">
                <span class="iconify" [attr.data-icon]="a.isActive ? 'mdi:shield-check' : 'mdi:shield-off-outline'"
                  [class.text-success]="a.isActive" [class.text-muted]="!a.isActive"></span>
              </button>
              <button class="btn-icon delete" (click)="delete(a)" title="Remove Entry">
                <span class="iconify" data-icon="mdi:trash-can-outline"></span>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="5" style="text-align:center; padding: 2rem;">No assignments found.</td>
        </tr>
      </table>

      <!-- Pagination -->
      <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </div>
  </div>
</div>