<div class="page">

  <div class="header-section">
    <button mat-button color="primary" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon> Back to Search
    </button>

    <div class="hotel-details" *ngIf="data && data.hotelName">
      <h2>{{data.hotelName}}</h2>
      <p class="subtitle">üìç {{data.city}}, {{data.address}}</p>
    </div>
  </div>
  <div class="filters-toolbar">
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Search Room or Type</mat-label>
      <input matInput [(ngModel)]="searchText" (ngModelChange)="applyFilter()" placeholder="Ex. 101 or Deluxe">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Room Type</mat-label>
      <mat-select [(ngModel)]="selectedRoomType" (selectionChange)="applyFilter()">
        <mat-option *ngFor="let type of uniqueRoomTypes" [value]="type">
          {{type}}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Sort By</mat-label>
      <mat-select [(ngModel)]="sortBy" (selectionChange)="applyFilter()">
        <mat-option value="price_asc">Price: Low to High</mat-option>
        <mat-option value="price_desc">Price: High to Low</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- LOADER -->
  <div *ngIf="loading" class="spinner-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Finding perfect rooms...</p>
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && filteredRooms.length === 0" class="empty-state">
    <mat-icon class="empty-icon">meeting_room</mat-icon>
    <h3>No rooms found matching your criteria.</h3>
    <p>Try adjusting your search or filters.</p>
  </div>

  <!-- ROOMS TABLE -->
  <div class="table-container" *ngIf="!loading && filteredRooms.length > 0">
    <table mat-table [dataSource]="pagedRooms" class="mat-elevation-z1 room-table">

      <!-- Select Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef> Select </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? toggle(row.roomId, row.totalPrice) : null"
            [checked]="isSelected(row.roomId)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Room Number Column -->
      <ng-container matColumnDef="roomNumber">
        <th mat-header-cell *matHeaderCellDef> Room # </th>
        <td mat-cell *matCellDef="let row">
          <strong>{{row.roomNumber}}</strong>
        </td>
      </ng-container>

      <!-- Room Type Column -->
      <ng-container matColumnDef="roomType">
        <th mat-header-cell *matHeaderCellDef> Type </th>
        <td mat-cell *matCellDef="let row">
          <span class="type-badge">{{row.roomType}}</span>
        </td>
      </ng-container>

      <!-- Max Guests Column -->
      <ng-container matColumnDef="maxGuests">
        <th mat-header-cell *matHeaderCellDef> Capacity </th>
        <td mat-cell *matCellDef="let row">
          <div style="display:flex; align-items:center; gap:4px;">
            <mat-icon style="font-size:18px; width:18px; height:18px">person</mat-icon>
            {{row.maxGuests}}
          </div>
        </td>
      </ng-container>

      <!-- Price Per Night Column -->
      <ng-container matColumnDef="pricePerNight">
        <th mat-header-cell *matHeaderCellDef> Rate/Night </th>
        <td mat-cell *matCellDef="let row"> ‚Çπ {{row.pricePerNight}} </td>
      </ng-container>

      <!-- Total Price Column -->
      <ng-container matColumnDef="totalPrice">
        <th mat-header-cell *matHeaderCellDef> Total Price </th>
        <td mat-cell *matCellDef="let row" style="font-weight:700; color:#0369a1;">
          ‚Çπ {{row.totalPrice}}
          <div *ngIf="processBreakdown(row.breakdown).length > 1"
            style="font-size:0.75rem; color:#d97706; font-weight:normal;">
            (Dynamic Rate)
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="toggle(row.roomId, row.totalPrice)"
        class="hover-row">
      </tr>
    </table>
  </div>

  <!-- PAGINATOR -->
  <mat-paginator [length]="filteredRooms.length" [pageSize]="pageSize" [pageSizeOptions]="[6, 12, 24]"
    (page)="onPageChange($event)" aria-label="Select page">
  </mat-paginator>

  <!-- FLOATING BOTTOM BAR -->
  <div class="bottom-bar" *ngIf="selected.length > 0">
    <div class="selection-summary">
      <span class="count">{{selected.length}} Room(s)</span>
      <span class="total">Total: ‚Çπ {{totalPrice}}</span>
    </div>
    <button mat-raised-button color="accent" (click)="book()">
      Book Now <mat-icon>arrow_forward</mat-icon>
    </button>
  </div>

</div>